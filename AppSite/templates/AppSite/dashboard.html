{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MSC Construction Between Acquirers</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Include Chart.js -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{% static 'AppSite/dashboard.css'%}">

</head>
<body>
    <!-- =============== Navigation ================ -->
    <div class="container">
        <div class="navigation">
            <ul>
                <li>
                    <a href="#">
                        <span class="icon">
                            <ion-icon name="logo-appl"></ion-icon>
                        </span>
                        <span class="title">Smart Path</span>
                    </a>
                </li>

                <li>
                    <a href="dashboard">
                        <span class="icon">
                            
                        </span>
                        <span class="title">Dashboard</span>
                    </a>
                </li>

                <li>
                    <a href="testing.html">
                        <span class="icon">

                        </span>
                        <span class="title">Customers</span>
                    </a>
                </li>

                <li>
                    <a href="#">
                        <span class="icon">

                        </span>
                        <span class="title">Messages</span>
                    </a>
                </li>

                <li>
                    <a href="#">
                        <span class="icon">

                        </span>
                        <span class="title">Help</span>
                    </a>
                </li>

                <li>
                    <a href="#">
                        <span class="icon">
  
                        </span>
                        <span class="title">Settings</span>
                    </a>
                </li>

                <li>
                    <a href="#">
                        <span class="icon">
                        <ion-icon name="log-out-outline"></ion-icon>          
                        </span>
                        <span class="title">Password</span>
                    </a>
                </li>

                <li>
                    <a href="#">
                        <span class="icon">
                        </span>
                        <span class="title">Sign Out</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- ========================= Main ==================== -->
        <div class="main">
            <div class="topbar">
                <div class="toggle">
                    <ion-icon name="menu-outline"></ion-icon>
                </div>
            </div>
            <div id="csv-container">
                <input type="file" id="csv-file" accept=".csv">
                <div id="csv-data"></div>
                <div class="direction_buttons">
                    <button id="backBtn" disabled>Back</button>
                    <button id="nextBtn" disabled>Next</button>
                </div>
            </div>
            <table>
                <tr>
                  <th>Card Type</th>
                  <th>3DS_Secure</th>
                  <th>CardHolder Country</th>
                  <th>Issuer Country</th>
                  <th>Merchant Code</th>
                  <th>Transaction Method</th>
                  <th>Amount</th>
                </tr>
                <tr>
                <td id = 'Card_type'></td>

                <td id = 'secure'></td>

                <td id = 'ch_country'></td>

                <td id = 'is_country'></td>

                <td id = 'merchant_code'></td>

                <td id = 'transmethod'></td>

                <td id = 'amount'></td>
                </tr>
              </table>
            <h1 id = 'AIB_msc'><br></h1>
            <h1 id = 'Evalon_msc'><br></h1>
            <h1 id = 'Barclays_msc'><br></h1>
            <h1 id = 'Lowest Amount'><br></h1>
   

            <div id="chart-container">
                <canvas id="myChart"></canvas> <!-- Canvas element to render the chart -->
            </div>
            <div style="width: 50%; float: left;">
              <canvas id="barChart"></canvas> <!-- Canvas element for the bar chart -->
            </div>
            <div style="width: 50%; float: left;">
              <canvas id="pieChart"></canvas> <!-- Canvas element for the pie chart -->
            </div>
        </div>


 
    <!-- =========== Scripts =========  -->

    <script>let list = document.querySelectorAll(".navigation li");

        function activeLink() {
          list.forEach((item) => {
            item.classList.remove("hovered");
          });
          this.classList.add("hovered");
        }
        
        list.forEach((item) => item.addEventListener("mouseover", activeLink));
        // Menu Toggle
        let toggle = document.querySelector(".toggle");
        let navigation = document.querySelector(".navigation");
        let main = document.querySelector(".main");
        
        toggle.onclick = function () {
          navigation.classList.toggle("active");
          main.classList.toggle("active");
        };
        
        function openCity(evt, cityName) {
          var i, tabcontent, tablinks;
          tabcontent = document.getElementsByClassName("tabcontent");
          for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
          }
          tablinks = document.getElementsByClassName("tablinks");
          for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
          }
          document.getElementById(cityName).style.display = "block";
          evt.currentTarget.className += " active";
        }
        
        // Get the element with id="defaultOpen" and click on it
        document.getElementById("defaultOpen").click();</script>
    <!-- ====== ionicons ======= -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script>
        // pulls data from the dictionary carried over named "context"
        var labels = {{ labels|safe }};
        var dataset1 = {{ dataset1|safe }};
        var dataset2 = {{ dataset2|safe }};
        var dataset3 = {{ dataset3|safe }};

        // Create the chart
        var ctx = document.getElementById('myChart').getContext('2d');
        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Interchange Rate',
                    backgroundColor: 'rgba(255, 99, 132, 0.5)', // makes it red
                    data: dataset1
                }, {
                    label: 'Scheme Fee',
                    backgroundColor: 'rgba(54, 162, 235, 0.5)', // makes it blue
                    data: dataset2
                },{
                    label: 'Margin',
                    backgroundColor: 'rgba(75, 192, 192, 0.5)', // makes it green
                    data: dataset3
                }
              ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'MSC Construction Between Acquirers'
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true
                    }
                }
            }
        });


// Create pie chart
var ctxPie = document.getElementById('pieChart').getContext('2d');
var NewList = []
for (let i = 0; i < dataset1.length; i++) {
    NewList.push(dataset1[i] + dataset2[i]+dataset3[i]);
}
var pieChart = new Chart(ctxPie, {
    type: 'pie',
    data: {
        labels: labels,
        datasets: [{
            label: 'Dataset 1',
            backgroundColor: [
                'rgba(255, 99, 132, 0.5)',
                'rgba(54, 162, 235, 0.5)',
                'rgba(255, 206, 86, 0.5)',
                'rgba(75, 192, 192, 0.5)',
                'rgba(153, 102, 255, 0.5)'
            ],
            data: NewList
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: true,
                text: 'Total MSC'
            }
        }
    }
});
</script>
<script>
    document.getElementById('csv-file').addEventListener('change', handleFileSelect);

    let csvData = [];
    let currentIndex = 1;

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            csvData = content.split('\n').map(row => row.trim().split(',')); // Parsing CSV data
            displayData();
        };
        reader.readAsText(file);
    }

    function displayData() {
    // Get the table cells by their IDs
    var cardTypeCell = document.getElementById('Card_type');
    var secureCell = document.getElementById('secure');
    var chCountryCell = document.getElementById('ch_country');
    var isCountryCell = document.getElementById('is_country');
    var merchantCodeCell = document.getElementById('merchant_code');
    var transMethodCell = document.getElementById('transmethod');
    var amountCell = document.getElementById('amount');

    // Get the data of the current row


    // Update each cell with the corresponding data from the row
    cardTypeCell.textContent = csvData[currentIndex][0];
    secureCell.textContent = csvData[currentIndex][1];
    chCountryCell.textContent = csvData[currentIndex][2];
    isCountryCell.textContent = csvData[currentIndex][3];
    merchantCodeCell.textContent = csvData[currentIndex][4];
    transMethodCell.textContent = csvData[currentIndex][5];
    amountCell.textContent = csvData[currentIndex][6];

        updateNavigationButtons();
    }

    function updateNavigationButtons() {
        const backBtn = document.getElementById('backBtn');
        const nextBtn = document.getElementById('nextBtn');

        backBtn.disabled = currentIndex === 1;
        nextBtn.disabled = currentIndex === csvData.length - 1;
    }

    document.getElementById('backBtn').addEventListener('click', function() {
        if (currentIndex > 0) {
            currentIndex--;
            displayData();
            fetchPythonOutput(); // Fetch Python output when navigating
        }
    });

    document.getElementById('nextBtn').addEventListener('click', function() {
        if (currentIndex < csvData.length - 1) {
            currentIndex++;
            displayData();
            fetchPythonOutput(); // Fetch Python output when navigating
        }
    });

    function fetchPythonOutput() {
    const selectedRowData = csvData[currentIndex]; // Get the data of the selected row
    fetch('/dashboard', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        // Include the selected row's data in the request body
        body: 'selected_row=' + encodeURIComponent(JSON.stringify(selectedRowData))
    })
    .then(response => response.json())
    .then(data => {

        // Set the formatted HTML as inner HTML of the element
        document.getElementById('python-output').innerHTML = html;
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
    </body>
</html>